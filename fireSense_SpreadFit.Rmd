---
title: "fireSense_SpreadFit"
author: "Jean Marchal"
date: "August 2016"
output:
  html_document: default
  pdf_document: default
---

# Overview
Fit statistical models that can be used to parametrize (calibrate) the fire spread component of simulation models (e.g. fireSense). This module makes use of Pattern Oriented Modelling (POM) to derive spread probabilities that can vary among pixels, i.e. reflecting heterogeneity in local environmental conditions.

# Download the module
```{r download module, eval = FALSE, echo = TRUE}
library(SpaDES)

moduleName <- "fireSense_SpreadFit"

workingDirectory <- tempdir() # Change this to a place you would like to put the module, if desired.

downloadModule(moduleName, path = workingDirectory)
```

# Usage
## Module parameters
Name|Default|Description
----|:-------:|---------------------------------------------------------------------
`formula`|`NULL`|an object of class `formula`: a symbolic description of the model to be fitted. Only the RHS needs to be provided.
`lower`|`NULL`|see `?DEoptim`.
`upper`|`NULL`|see `?DEoptim`.
`data`|`NULL`|optional. A character vector indicating the names of objects in the `simList` environment in which to look for variables in the model. Data objects can be named `lists` of `RasterLayers` or `RasterStacks` (for time series), but should all be of one unique class, e.g. `RasterLayer`. If omitted, or if variables are not found in data objects, variables are searched in the `simList` environment.
`mapping`|`NULL`|optional. Named `character vector` or `list` mapping the names of data objects required by the module to those in the `simList` environment.
`trace`|`0`|non-negative `integer`. If > 0, tracing information on the progress of the optimization is produced every trace iteration. Defaults to 0 which indicates no tracing information is to be printed.
`parallel`|`FALSE`|Should the optimization be parallelized ? (all detected cores will be used).
`initialRunTime`|`start(sim)`|optional. Simulation time at which to start this module. Defaults to simulation start time.
`intervalRunModule`|`NA`|optional. Interval in simulation time units between two runs of this module.
|||

## Usage example
```{r module usage example, eval = FALSE}
library(SpaDES)
library(PtProcess)

# Packages required by the module
library(data.table)
library(DEoptim)
library(kSamples)
library(magrittr)
library(parallel)
library(raster)

set.seed(1)

# Example where all fires are spread at the same time:
  # Create an SpatialPointsDataFrame containing fire locations and final sizes data
  coords <- data.frame(x_coord = runif(1000, -100, 100),
                       y_coord = runif(1000, -100, 100))
  data <- data.frame(size = rtappareto(1000, .3, 1e4, 1))
  firesMappingExample <- SpatialPointsDataFrame(coords, data)
  
  # Create a random map of weather
  nx <- ny <- 100L
  weather <- raster(nrows = ny, ncols = nx, xmn = -nx/2, xmx = nx/2, ymn = -ny/2, ymx = ny/2) %>%
    gaussMap(scale = 300, var = 0.03, speedup = nx/5e2, inMemory = TRUE)

# Example for times series, i.e. where fires are spread at different times:
  # Create an SpatialPointsDataFrame containing fire locations, starting dates, and final sizes data
  coords <- data.frame(x_coord = runif(1000, -100, 100),
                       y_coord = runif(1000, -100, 100))
  data <- data.frame(date = sample(2000:2003, size = 1000, replace = TRUE),
                     size = rtappareto(1000, .3, 1e4, 1))
  firesMappingExample <- SpatialPointsDataFrame(coords, data)
  
  # Create a time series of random maps of weather
  nx <- ny <- 100L
  weather <- lapply(2000:2003, function(x) {
    raster(nrows = ny, ncols = nx, xmn = -nx/2, xmx = nx/2, ymn = -ny/2, ymx = ny/2) %>%
      gaussMap(scale = 300, var = 0.03, speedup = nx/5e2, inMemory = TRUE)
  }) %>% stack

#outputDir <- file.path(tempdir(), "outputs")
times <- list(start = 1, end = 1, timeunit = "year")
parameters <- list(
  fireSense_SpreadFit = list(
    formula = ~ weather - 1,
    lower = c(.2, .1, .01, .3, 0.001),
    upper = c(.5, 10, .2, 4, .3),
    mapping = c(fires = "firesMappingExample"), # One can use mapping to map data required by the
                                                # module to data objects in the simList environment.
                                                # Here "fires" is mapped to "firesMappingExample".
    trace = 5, # Print progress every 5 iterations
    parallel = TRUE # Use parallel processing
  )
)

modules <- list("fireSense_SpreadFit")
objects <- c("firesMappingExample", 
             "weather") # Pass objects found in the global environment to the simList environment

paths <- list(
  # cachePath = file.path(outputDir, "cache"),
  modulePath = file.path("~/Documents/GitHub/McIntire-lab/modulesPrivate/") ## TODO: change this to tempdir()
  # inputPath = inputDir,
  # outputPath = outputDir
)

mySim <- simInit(times = times, params = parameters, modules = modules, objects = objects, paths = paths)

spades(mySim)
```

# Events
Events are scheduled as follows:

- Module initiation
- Model fitting

## Saving
TODO: Write what is saved. (there is currently nothing saved, but this may change in the future)

# Data dependencies
## Input data
- An object of class `RasterLayer` or `RasterStack` or named `lists` of `RasterLayers` or `RasterStacks`, in which to look for variables with which to predict. `RasterStacks` are useful in cases where fires started at different dates, and thus should not be spread at the same time; but are used to describe a single fire size distribution.
- An object of class `SpatialPointsDataFrame` describing fire starting locations, starting dates (column **date**), and final sizes (column **size**).

## Output data
An object of class `fireSense_SpreadFit`, i.e. a `list` containing the following components:

- **formula**
- **coef** (A, B, D, G are parameters of the logistic function)

# Links to other modules
This module can be used in association with fireSense_SpreadPredict to derive fire spread probabilities that are sensistive to environmental conditions.

